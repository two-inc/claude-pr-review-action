name: 'Claude Code Review'
description: 'Automated code reviews using Claude AI'
author: 'Two Inc'

inputs:
  anthropic_api_key:
    description: 'Anthropic API key for Claude'
    required: true
  track_progress:
    description: 'Enable visual progress tracking comments'
    required: false
    default: 'false'
  use_sticky_comment:
    description: 'Use sticky comments for consistent feedback across PR updates'
    required: false
    default: 'true'
  prompt:
    description: 'Custom review prompt'
    required: false
    default: |
      REPO: ${{ github.repository }}
      PR NUMBER: ${{ github.event.pull_request.number || github.event.issue.number }}

      **LINEAR_API_KEY Integration**:
      If LINEAR_API_KEY is available in the environment, create Linear issues for any significant problems or follow-up work that developers should address.

      **STEP 1 - Determine PR Type**:
      First, use `mcp__github__get_pull_request` to read the PR title, description, and branch names to determine if this is a release PR.

      **Release PR Detection**:
      If the PR title, branch name, or description contains patterns like "release", "version", "v[0-9]", "bump", "tag", or if it's merging a release branch to main, treat it as a release PR.

      **For Release PRs**: Create a release summary instead of a detailed review:
      1. **MANDATORY - Check for existing summaries**: Use `Bash(gh api graphql: *)` to query all PR comments and see if a release summary already exists
      2. **NEVER duplicate summaries**: If a release summary comment already exists, DO NOT create another one
      3. **Create release summary**: Use `mcp__github__create_pull_request_comment` to post a single comprehensive release summary covering:
         - Key features and changes
         - Breaking changes or migrations needed
         - Notable bug fixes
         - Dependencies or version updates
         - Any security improvements
      4. **Do NOT create a review**: Skip the normal review process entirely

      **For Regular PRs**: Follow normal review process with extreme selectivity:
      1. **MANDATORY - Read ALL existing comments FIRST**: Use `Bash(gh api graphql: *)` to query ALL existing comments and review threads from Claude and other reviewers BEFORE starting anything (supports paging for complete coverage)
      2. **Start a review**: Use `Bash(gh api graphql: *)` with createPullRequestReview mutation to begin a pending review
      3. **Get diff information**: Use `mcp__github__get_pull_request_diff` to understand the code changes and line numbers
      4. **Cross-reference with existing comments**: Before making ANY comment, check if the same issue has already been raised by Claude or any other reviewer in previous comments
      5. **Add inline comments**: Use `Bash(gh api graphql: *)` with addPullRequestReviewComment mutation ONLY for critical issues that have NOT been previously mentioned
      6. **Submit review**:
         - If you added comments: Use `Bash(gh api graphql: *)` with submitPullRequestReview mutation with event type "COMMENT" to publish comments
         - If no comments were added: Use `Bash(gh api graphql: *)` with submitPullRequestReview mutation with event type "APPROVE" to approve the PR
      7. **Resolve fixed issues**: Check if any issues you previously raised in earlier commits have been fixed in this commit. Use `Bash(gh api graphql: *)` with resolveReviewThread mutation to resolve those threads.
      8. **Mark resolved comments as resolved**: Use `Bash(gh api graphql: *)` with resolveReviewThread mutation to resolve addressed comments

      **ONLY comment on these critical issues:**
      - **Security vulnerabilities** (SQL injection, XSS, authentication bypasses, etc.)
      - **Critical bugs** that will cause runtime failures, data corruption, or crashes
      - **Memory leaks** or severe performance bottlenecks
      - **Breaking API changes** that will break existing functionality
      - **Data loss risks** or unsafe database operations

      **DO NOT comment on:**
      - Minor style issues or formatting
      - Subjective code organisation preferences
      - Non-critical performance optimisations
      - Minor refactoring suggestions
      - Documentation improvements
      - Variable naming (unless genuinely confusing)
      - Code that works correctly but could be "better"

      **Rules:**
      - **NEVER duplicate existing comments**: If Claude or any other reviewer has already mentioned an issue, DO NOT comment on it again
      - **AVOID top-level comments**: Always prefer inline comments on specific lines. Only use top-level PR comments for release summaries or overall PR concerns that cannot be tied to specific code lines
      - **Always resolve fixed issues**: If you previously raised an issue in an earlier commit and it has been fixed in a follow-up commit, you MUST resolve that thread
      - If unsure whether an issue is critical enough, DON'T comment
      - If unsure whether an issue has already been raised, DON'T comment
      - Maximum 3 comments per PR unless there are genuine security/critical issues
      - Each comment must identify a specific, actionable problem that risks system stability, security, or data integrity
      - If no NEW critical issues found (beyond what's already been commented), approve the PR instead of leaving comments
  extra_prompt:
    description: 'Additional instructions to append to the base prompt'
    required: false
    default: ''
  claude_args:
    description: 'Additional Claude CLI arguments'
    required: false
    default: '--allowedTools "mcp__github__get_pull_request,mcp__github__create_pull_request_comment,mcp__github__get_pull_request_diff,Bash(gh api graphql:*)"'

runs:
  using: 'composite'
  steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Run Claude Code Review
      uses: anthropics/claude-code-action@v1
      with:
        anthropic_api_key: ${{ inputs.anthropic_api_key }}
        track_progress: ${{ inputs.track_progress }}
        use_sticky_comment: ${{ inputs.use_sticky_comment }}
        prompt: |
          ${{ inputs.prompt }}

          ${{ inputs.extra_prompt }}
        claude_args: ${{ inputs.claude_args }}
